# Story 7.1: Arquitetura do Sistema CLI

**Epic:** EP-07 - Gerador de Roteiros CLI
**Story ID:** 7.1
**Prioridade:** :fire: Critica
**Pontos:** 8
**Esforco:** 5-7 horas
**Status:** :white_circle: Draft
**Tipo:** :gear: Arquitetura & Planejamento Tecnico

---

## User Story

Como **desenvolvedor do projeto Mente Leve**, quero **definir a arquitetura completa do sistema CLI gerador de roteiros, incluindo inputs, outputs, fluxo de dados e tecnologias**, para que **a implementacao seja clara, modular e escalavel desde o primeiro commit**.

## Objetivo

Documentar a arquitetura tecnica do CLI que gera roteiros de conteudo com o DNA da Gaby, Light Copy Pattern e personalizacao por avatar. O sistema recebe inputs simples (tema, avatar, formato), processa via prompts de IA e entrega roteiros prontos para uso. A arquitetura deve ser simples o suficiente para um dev solo e robusta o suficiente para iterar com facilidade.

## Contexto & Fundamentacao

- O CLI e uma ferramenta interna para gerar conteudo com consistencia de tom
- Resolve o problema de manter o DNA da Gaby em escala (muitos conteudos, um tom)
- Tecnologia: Node.js (alinhado com stack do projeto)
- IA: OpenAI API (GPT-4) ou Claude API como motor de geracao
- 3 avatares (Marina, Julia, Camila) definem personalizacao de tom e dor
- 5 formatos de saida: reel 30s, reel 60s, carrossel, story, post feed
- Light Copy Pattern de 6 passos guia a estrutura dos roteiros
- Deve ser simples: `npx sadhana-cli` e pronto

## Scope

### Incluido
- Diagrama de arquitetura do sistema (inputs -> processamento -> outputs)
- Definicao de todas as interfaces (CLI inputs, API calls, outputs)
- Estrutura de pastas e modulos do projeto
- Escolha e justificativa de tecnologias
- Fluxo de dados passo a passo
- Configuracao de ambiente e dependencias
- Modelo de dados para roteiros gerados

### Excluido
- Implementacao de codigo (Story 7.3)
- Criacao dos prompts de IA (Story 7.2)
- Selecao de avatar detalhada (Story 7.4)
- Selecao de formato detalhada (Story 7.5)
- Testes e validacao (Story 7.6)

### Dependencias
- Story 3.1 (Framework Light Copy) -- estrutura dos roteiros
- Story 1.1 (Manifesto Sadhana) -- DNA da Gaby para contexto
- Acesso a API de IA (OpenAI ou Anthropic)

### Entregaveis para downstream
- Story 7.2 (Prompts) -- usa arquitetura como base
- Story 7.3 (CLI Basico) -- implementa esta arquitetura
- Story 7.4 (Avatar) -- extende inputs definidos aqui
- Story 7.5 (Formato) -- extende outputs definidos aqui

## Tasks Breakdown

### Fase 1: Definicao de Inputs e Outputs (~1.5h)
- [ ] Mapear todos os inputs do CLI
  - [ ] `tema` (obrigatorio): assunto do roteiro (ex: "ansiedade", "rotina matinal")
  - [ ] `avatar` (opcional, default: geral): Marina, Julia ou Camila
  - [ ] `formato` (opcional, default: post feed): reel-30, reel-60, carrossel, story, post
  - [ ] `tom` (opcional, default: padrao): intensidade do tom Sadhana (suave, padrao, poetico)
  - [ ] `saida` (opcional, default: terminal): terminal, arquivo .md, clipboard
- [ ] Mapear todos os outputs
  - [ ] Roteiro em texto formatado (Markdown)
  - [ ] Metadata: avatar usado, formato, tema, timestamp
  - [ ] Estimativa de duracao (para reels) ou numero de slides (para carrossel)
  - [ ] Hashtags sugeridas
- [ ] Definir modelo de dados do roteiro
  ```javascript
  {
    id: "sadhana-2026-02-14-001",
    tema: "ansiedade",
    avatar: "marina",
    formato: "reel-60",
    tom: "padrao",
    roteiro: {
      abertura: "...",
      diagnostico: "...",
      reframe: "...",
      validacao: "...",
      convite: "...",
      encerramento: "..."
    },
    metadata: {
      duracao_estimada: "55-65s",
      hashtags: ["#SadhanaReal", "#MenteLeve", "..."],
      gerado_em: "2026-02-14T10:30:00Z",
      modelo_ia: "gpt-4",
      versao_prompt: "1.0"
    }
  }
  ```

### Fase 2: Diagrama de Arquitetura (~1.5h)
- [ ] Criar diagrama de fluxo do sistema
  ```
  [Usuario] -> [CLI Interface] -> [Input Validator]
                                       |
                                       v
                              [Prompt Builder]
                              (tema + avatar + formato)
                                       |
                                       v
                              [AI Service Layer]
                              (OpenAI / Claude API)
                                       |
                                       v
                              [Output Formatter]
                              (Markdown + Metadata)
                                       |
                                       v
                              [Output Handler]
                              (terminal / arquivo / clipboard)
  ```
- [ ] Documentar cada modulo com responsabilidades
  - [ ] `cli.js` -- interface de linha de comando (inquirer/prompts)
  - [ ] `validator.js` -- valida e normaliza inputs
  - [ ] `prompt-builder.js` -- monta o prompt completo para a IA
  - [ ] `ai-service.js` -- comunica com a API de IA
  - [ ] `formatter.js` -- formata output em Markdown
  - [ ] `output-handler.js` -- direciona saida (terminal, arquivo, clipboard)
  - [ ] `config.js` -- configuracoes (API key, modelo, versao)
- [ ] Definir interfaces entre modulos (contratos)

### Fase 3: Estrutura de Pastas (~1h)
- [ ] Definir estrutura do projeto
  ```
  sadhana-cli/
  ├── package.json
  ├── .env.example
  ├── .gitignore
  ├── README.md
  ├── bin/
  │   └── sadhana.js          # Entry point
  ├── src/
  │   ├── cli.js              # Interface CLI
  │   ├── validator.js        # Validacao de inputs
  │   ├── prompt-builder.js   # Construcao de prompts
  │   ├── ai-service.js       # Camada de IA
  │   ├── formatter.js        # Formatacao de output
  │   ├── output-handler.js   # Saida (terminal/arquivo)
  │   └── config.js           # Configuracoes
  ├── prompts/
  │   ├── system-prompt.md    # System prompt base
  │   ├── avatars/
  │   │   ├── marina.md       # Contexto Marina
  │   │   ├── julia.md        # Contexto Julia
  │   │   └── camila.md       # Contexto Camila
  │   └── formatos/
  │       ├── reel-30.md      # Estrutura reel 30s
  │       ├── reel-60.md      # Estrutura reel 60s
  │       ├── carrossel.md    # Estrutura carrossel
  │       ├── story.md        # Estrutura story
  │       └── post-feed.md    # Estrutura post feed
  ├── output/                 # Roteiros gerados (gitignored)
  └── tests/
      ├── validator.test.js
      ├── prompt-builder.test.js
      └── formatter.test.js
  ```
- [ ] Definir dependencias do projeto
  ```json
  {
    "dependencies": {
      "inquirer": "^9.0.0",
      "openai": "^4.0.0",
      "chalk": "^5.0.0",
      "clipboardy": "^4.0.0",
      "dotenv": "^16.0.0"
    },
    "devDependencies": {
      "vitest": "^1.0.0",
      "eslint": "^8.0.0"
    }
  }
  ```
- [ ] Criar `.env.example`
  ```
  OPENAI_API_KEY=sk-...
  AI_MODEL=gpt-4
  PROMPT_VERSION=1.0
  OUTPUT_DIR=./output
  ```

### Fase 4: Fluxo de Dados Detalhado (~1h)
- [ ] Documentar fluxo completo passo a passo
  1. Usuario executa `npx sadhana-cli` (ou `node bin/sadhana.js`)
  2. CLI pergunta tema (texto livre)
  3. CLI pergunta avatar (selecao: Marina, Julia, Camila, Geral)
  4. CLI pergunta formato (selecao: reel-30, reel-60, carrossel, story, post)
  5. Validator normaliza inputs
  6. Prompt Builder monta prompt:
     - System prompt (DNA Gaby + Light Copy + regras Sadhana)
     - Contexto do avatar selecionado
     - Estrutura do formato selecionado
     - Tema do usuario
  7. AI Service envia para API e recebe resposta
  8. Formatter estrutura em Markdown com metadata
  9. Output Handler exibe no terminal (e opcionalmente salva)
  10. Usuario pode gerar outro ou sair
- [ ] Definir tratamento de erros em cada passo
  - [ ] API indisponivel -> retry 3x, depois mensagem amigavel
  - [ ] Input invalido -> mensagem clara + pedir novamente
  - [ ] Resposta da IA fora do formato -> parse graceful + aviso
- [ ] Definir estimativa de custo por geracao
  - [ ] ~1500 tokens de prompt + ~500 tokens de resposta = ~2000 tokens/geracao
  - [ ] Custo estimado: ~R$0,15 por roteiro (GPT-4)

### Fase 5: Documentacao & Decisoes (~1h)
- [ ] Documentar decisoes de tecnologia com justificativa
  - [ ] Node.js: alinhado com stack, rapido pra CLI
  - [ ] Inquirer: melhor lib de prompts interativos
  - [ ] OpenAI SDK: mais estavel, fallback para Claude
  - [ ] Vitest: rapido, moderno, zero config
  - [ ] Chalk: output colorido no terminal
- [ ] Documentar ADRs (Architecture Decision Records)
  - [ ] ADR-01: Prompts em arquivos .md separados (nao hardcoded)
  - [ ] ADR-02: Sem banco de dados (output em arquivos .md)
  - [ ] ADR-03: API key via .env (nao commitada)
  - [ ] ADR-04: Modular por design (cada modulo testavel isolado)
- [ ] Criar diagrama de sequencia simplificado

## Acceptance Criteria

### Must Have
- [ ] Diagrama de arquitetura com todos os modulos
- [ ] Modelo de dados do roteiro definido (JSON schema)
- [ ] Estrutura de pastas completa
- [ ] Lista de dependencias com versoes
- [ ] Fluxo de dados passo a passo documentado
- [ ] Interfaces entre modulos definidas (contratos)
- [ ] Tratamento de erros mapeado

### Should Have
- [ ] ADRs documentados (decisoes de tecnologia)
- [ ] Estimativa de custo por geracao
- [ ] `.env.example` com todas as variaveis
- [ ] Diagrama de sequencia

### Nice to Have
- [ ] Prototipo de `package.json` completo
- [ ] Script de setup (`npm run setup`)
- [ ] Suporte a multiplas APIs de IA (OpenAI + Claude)

## Entregaveis

| Entregavel | Localizacao | Conteudo | Usado Por |
|---|---|---|---|
| Documento de Arquitetura | `docs/cli/arquitetura-cli.md` | Diagramas, modulos, fluxo | Dev (Story 7.3) |
| Modelo de Dados | `docs/cli/modelo-dados-roteiro.md` | JSON schema + exemplos | Dev |
| ADRs | `docs/cli/adrs/` | Decisoes tecnicas | Dev, futuro |
| Estrutura de Pastas | `docs/cli/estrutura-projeto.md` | Arvore + descricao | Dev |

## Metricas de Sucesso

| Metrica | Meta | Como Medir |
|---|---|---|
| Completude da documentacao | 100% dos modulos documentados | Revisao |
| Clareza do fluxo | Dev entende em 1 leitura | Feedback do dev |
| Modularidade | Cada modulo testavel isolado | Contagem de interfaces |
| Simplicidade | < 10 dependencias | package.json |
| Custo por geracao | < R$0,20 | Estimativa + teste real |

## Riscos & Mitigacao

| Risco | Probabilidade | Impacto | Mitigacao |
|---|---|---|---|
| Arquitetura over-engineered | Media | Medio | KISS: minimo de modulos, maximo de clareza |
| API de IA muda interface | Baixa | Alto | Camada de abstracao (ai-service.js) |
| Custo de API alto demais | Media | Medio | Estimar antes, usar modelo mais barato para testes |
| Prompts em .md limitam flexibilidade | Baixa | Baixo | Migrar para templates se necessario |

## Regras de Comunicacao (Sadhana)

### SEMPRE
- Documentacao tecnica acessivel (dev solo + nao-devs entendem o conceito)
- Nomes de modulos em ingles (padrao de codigo)
- Comentarios no codigo em portugues (time brasileiro)
- README com instrucoes claras de setup e uso

### NUNCA
- Complexidade desnecessaria (YAGNI)
- Dependencias sem justificativa
- API keys no codigo ou no git
- Arquitetura que exige DevOps complexo

## Referencias

- Story 3.1 (Framework Light Copy) -- estrutura dos roteiros
- Story 1.1 (Manifesto Sadhana) -- DNA da Gaby
- Node.js CLI best practices
- OpenAI API documentation

## Change Log

| Data | Mudanca | Autor |
|---|---|---|
| 2026-02-14 | Story criada | Morgan (PM) |

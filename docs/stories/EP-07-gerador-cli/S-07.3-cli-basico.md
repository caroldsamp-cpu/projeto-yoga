# Story 7.3: Implementacao do CLI Basico

**Epic:** EP-07 - Gerador de Roteiros CLI
**Story ID:** 7.3
**Prioridade:** :fire: Critica
**Pontos:** 8
**Esforco:** 6-8 horas
**Status:** :white_circle: Draft
**Tipo:** :computer: Desenvolvimento

---

## User Story

Como **criadora de conteudo do NamaSer**, quero **digitar um tema no terminal e receber um roteiro pronto com tom Sadhana**, para que **eu possa gerar conteudo consistente sem depender de inspiracao ou reescrita manual do tom**.

## Objetivo

Implementar a versao minima funcional do CLI: usuario digita um tema, o sistema envia para a API de IA com o system prompt do DNA da Gaby e retorna um roteiro formatado no terminal. Esta e a versao MVP -- sem selecao de avatar ou formato (adicionados nas Stories 7.4 e 7.5). Foco: funcionar de ponta a ponta.

## Contexto & Fundamentacao

- Arquitetura definida na Story 7.1 (modulos, fluxo, dependencias)
- Prompts criados na Story 7.2 (system prompt + user prompt template)
- MVP: input simples (tema) -> output simples (roteiro no terminal)
- Tecnologia: Node.js, Inquirer, OpenAI SDK, Chalk
- Sem avatar (usa "geral") e sem formato (usa "post feed") no MVP
- Objetivo: validar o fluxo completo antes de adicionar complexidade

## Scope

### Incluido
- Setup do projeto Node.js (package.json, dependencias, .env)
- CLI interativo com Inquirer (pergunta tema)
- Integracao com OpenAI API (enviar prompt, receber resposta)
- Formatacao de output no terminal com Chalk
- Salvamento opcional em arquivo .md
- Tratamento de erros basico (API, input, rede)
- Entry point executavel (`node bin/sadhana.js`)

### Excluido
- Selecao de avatar (Story 7.4)
- Selecao de formato (Story 7.5)
- Testes automatizados (Story 7.6 -- mas testes manuais sim)
- Publicacao no npm
- Interface web ou GUI

### Dependencias
- Story 7.1 (Arquitetura) -- estrutura de pastas e modulos
- Story 7.2 (Prompts) -- system prompt e user prompt template
- API key da OpenAI configurada
- Node.js 18+ instalado

### Entregaveis para downstream
- Story 7.4 (Avatar) -- extende CLI com selecao de avatar
- Story 7.5 (Formato) -- extende CLI com selecao de formato
- Story 7.6 (Testes) -- testa este CLI

## Tasks Breakdown

### Fase 1: Setup do Projeto (~1.5h)
- [ ] Inicializar projeto Node.js
  - [ ] `npm init` com dados do projeto
  - [ ] Instalar dependencias: inquirer, openai, chalk, dotenv, clipboardy
  - [ ] Instalar devDependencies: vitest, eslint
  - [ ] Configurar ESLint basico
- [ ] Criar estrutura de pastas (conforme Story 7.1)
  ```
  sadhana-cli/
  â”œâ”€â”€ package.json
  â”œâ”€â”€ .env
  â”œâ”€â”€ .env.example
  â”œâ”€â”€ .gitignore
  â”œâ”€â”€ bin/
  â”‚   â””â”€â”€ sadhana.js
  â”œâ”€â”€ src/
  â”‚   â”œâ”€â”€ cli.js
  â”‚   â”œâ”€â”€ validator.js
  â”‚   â”œâ”€â”€ prompt-builder.js
  â”‚   â”œâ”€â”€ ai-service.js
  â”‚   â”œâ”€â”€ formatter.js
  â”‚   â”œâ”€â”€ output-handler.js
  â”‚   â””â”€â”€ config.js
  â”œâ”€â”€ prompts/
  â”‚   â”œâ”€â”€ system-prompt.md
  â”‚   â””â”€â”€ user-prompt-template.md
  â”œâ”€â”€ output/
  â””â”€â”€ tests/
  ```
- [ ] Configurar .env com API key
- [ ] Configurar .gitignore (node_modules, .env, output/)
- [ ] Testar que `node bin/sadhana.js` executa sem erro

### Fase 2: Modulo CLI (cli.js) (~1h)
- [ ] Implementar interface interativa com Inquirer
  ```javascript
  import inquirer from 'inquirer';
  import chalk from 'chalk';

  export async function startCLI() {
    console.log(chalk.yellow('\n  Sadhana CLI - Gerador de Roteiros\n'));
    console.log(chalk.dim('  Gere conteudo com o DNA da Gaby.\n'));

    const answers = await inquirer.prompt([
      {
        type: 'input',
        name: 'tema',
        message: 'Qual o tema do roteiro?',
        validate: (input) => {
          if (!input.trim()) return 'Por favor, digite um tema.';
          return true;
        }
      },
      {
        type: 'confirm',
        name: 'salvar',
        message: 'Salvar em arquivo?',
        default: false
      }
    ]);

    return answers;
  }
  ```
- [ ] Adicionar mensagem de boas-vindas estilizada
- [ ] Adicionar opcao de gerar outro roteiro ou sair
- [ ] Adicionar spinner durante geracao (ora2 ou similar)

### Fase 3: Modulo Prompt Builder (prompt-builder.js) (~1h)
- [ ] Implementar leitura dos arquivos .md de prompts
  ```javascript
  import { readFileSync } from 'fs';
  import { join } from 'path';

  export function buildPrompt(tema) {
    const systemPrompt = readFileSync(
      join(__dirname, '../prompts/system-prompt.md'),
      'utf-8'
    );

    const userPromptTemplate = readFileSync(
      join(__dirname, '../prompts/user-prompt-template.md'),
      'utf-8'
    );

    const userPrompt = userPromptTemplate
      .replace('{{tema}}', tema)
      .replace('{{avatar_nome}}', 'Geral')
      .replace('{{avatar_contexto_resumido}}', 'Todas as mulheres')
      .replace('{{formato}}', 'Post Feed')
      .replace('{{formato_instrucoes}}', 'Texto para feed do Instagram');

    return { systemPrompt, userPrompt };
  }
  ```
- [ ] Validar que os arquivos de prompt existem
- [ ] Tratar erro se arquivo de prompt nao encontrado

### Fase 4: Modulo AI Service (ai-service.js) (~1.5h)
- [ ] Implementar integracao com OpenAI API
  ```javascript
  import OpenAI from 'openai';
  import { config } from './config.js';

  const openai = new OpenAI({
    apiKey: config.OPENAI_API_KEY
  });

  export async function generateRoteiro(systemPrompt, userPrompt) {
    try {
      const response = await openai.chat.completions.create({
        model: config.AI_MODEL,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ],
        temperature: 0.7,
        max_tokens: 1500
      });

      return {
        roteiro: response.choices[0].message.content,
        tokens: response.usage,
        modelo: config.AI_MODEL
      };
    } catch (error) {
      if (error.status === 429) {
        throw new Error('Limite de requisicoes atingido. Tente novamente em 1 minuto.');
      }
      if (error.status === 401) {
        throw new Error('API key invalida. Verifique seu .env.');
      }
      throw new Error(`Erro ao gerar roteiro: ${error.message}`);
    }
  }
  ```
- [ ] Implementar retry (3 tentativas com backoff)
- [ ] Implementar timeout (30 segundos)
- [ ] Log de tokens usados para estimativa de custo

### Fase 5: Modulo Formatter e Output (~1h)
- [ ] Implementar formatacao para terminal
  ```javascript
  import chalk from 'chalk';

  export function formatForTerminal(roteiro, metadata) {
    const separator = chalk.dim('â”€'.repeat(50));

    let output = '\n';
    output += separator + '\n';
    output += chalk.yellow.bold('  ROTEIRO SADHANA') + '\n';
    output += chalk.dim(`  Tema: ${metadata.tema}`) + '\n';
    output += chalk.dim(`  Avatar: ${metadata.avatar}`) + '\n';
    output += chalk.dim(`  Formato: ${metadata.formato}`) + '\n';
    output += separator + '\n\n';
    output += roteiro + '\n\n';
    output += separator + '\n';
    output += chalk.dim(`  Tokens: ${metadata.tokens}`) + '\n';
    output += chalk.dim(`  Modelo: ${metadata.modelo}`) + '\n';
    output += separator + '\n';

    return output;
  }
  ```
- [ ] Implementar salvamento em arquivo .md
  ```javascript
  import { writeFileSync } from 'fs';
  import { join } from 'path';

  export function saveToFile(roteiro, metadata) {
    const filename = `sadhana-${metadata.tema.replace(/\s+/g, '-')}-${Date.now()}.md`;
    const filepath = join(config.OUTPUT_DIR, filename);

    const content = `# Roteiro Sadhana: ${metadata.tema}\n\n`
      + `**Avatar:** ${metadata.avatar}\n`
      + `**Formato:** ${metadata.formato}\n`
      + `**Gerado em:** ${new Date().toISOString()}\n\n`
      + `---\n\n`
      + roteiro;

    writeFileSync(filepath, content, 'utf-8');
    return filepath;
  }
  ```
- [ ] Implementar copia para clipboard (opcional)

### Fase 6: Integracao e Entry Point (~1h)
- [ ] Montar entry point (bin/sadhana.js)
  ```javascript
  #!/usr/bin/env node

  import { startCLI } from '../src/cli.js';
  import { buildPrompt } from '../src/prompt-builder.js';
  import { generateRoteiro } from '../src/ai-service.js';
  import { formatForTerminal, saveToFile } from '../src/formatter.js';
  import chalk from 'chalk';

  async function main() {
    try {
      const { tema, salvar } = await startCLI();
      const { systemPrompt, userPrompt } = buildPrompt(tema);

      console.log(chalk.dim('\n  Gerando roteiro...\n'));

      const { roteiro, tokens, modelo } = await generateRoteiro(
        systemPrompt, userPrompt
      );

      const metadata = {
        tema,
        avatar: 'Geral',
        formato: 'Post Feed',
        tokens: `${tokens.total_tokens} tokens`,
        modelo
      };

      console.log(formatForTerminal(roteiro, metadata));

      if (salvar) {
        const filepath = saveToFile(roteiro, metadata);
        console.log(chalk.green(`  Salvo em: ${filepath}\n`));
      }

    } catch (error) {
      console.error(chalk.red(`\n  Erro: ${error.message}\n`));
      process.exit(1);
    }
  }

  main();
  ```
- [ ] Testar fluxo completo: tema -> roteiro -> terminal
- [ ] Testar fluxo com salvamento em arquivo
- [ ] Testar cenarios de erro: sem API key, sem internet, tema vazio
- [ ] Confirmar que o roteiro gerado segue o tom Sadhana

### Fase 7: Polish & Documentacao (~0.5h)
- [ ] Adicionar README basico com instrucoes de uso
  ```
  ## Sadhana CLI

  ### Setup
  1. npm install
  2. cp .env.example .env
  3. Adicionar OPENAI_API_KEY no .env

  ### Uso
  node bin/sadhana.js

  ### Gerar roteiro
  - Digite o tema quando perguntado
  - Escolha se quer salvar em arquivo
  - Roteiro aparece no terminal
  ```
- [ ] Limpar console.logs de debug
- [ ] Verificar que .env nao esta no git

## Acceptance Criteria

### Must Have
- [ ] `node bin/sadhana.js` executa sem erro
- [ ] CLI pergunta tema via Inquirer
- [ ] Sistema envia prompt para OpenAI API e recebe resposta
- [ ] Roteiro e exibido formatado no terminal
- [ ] Roteiro segue tom Sadhana (teste manual: "Gaby diria isso?")
- [ ] Tratamento de erro para API key invalida e rede indisponivel
- [ ] .env com API key nao commitado no git

### Should Have
- [ ] Opcao de salvar em arquivo .md
- [ ] Spinner durante geracao
- [ ] Log de tokens usados
- [ ] Opcao de gerar outro roteiro ou sair
- [ ] Output colorido com Chalk

### Nice to Have
- [ ] Copia para clipboard
- [ ] Tempo de geracao exibido
- [ ] Sugestao de temas se usuario nao tem ideia

## Entregaveis

| Entregavel | Localizacao | Conteudo | Usado Por |
|---|---|---|---|
| CLI funcional | `sadhana-cli/` | Projeto Node.js completo | Equipe de conteudo |
| Entry point | `sadhana-cli/bin/sadhana.js` | Script executavel | Usuario |
| Modulos | `sadhana-cli/src/` | 6 modulos conforme arquitetura | Dev |
| README | `sadhana-cli/README.md` | Instrucoes de setup e uso | Dev, equipe |

## Metricas de Sucesso

| Metrica | Meta | Como Medir |
|---|---|---|
| Tempo de setup (do zero) | < 5 minutos | Cronometro |
| Tempo de geracao (tema -> roteiro) | < 30 segundos | Cronometro |
| Taxa de erro (falha na geracao) | < 5% | Log |
| Roteiro no tom Sadhana | > 80% aprovacao | Teste manual |
| Custo por geracao | < R$0,20 | Log de tokens |

## Riscos & Mitigacao

| Risco | Probabilidade | Impacto | Mitigacao |
|---|---|---|---|
| API key exposta no git | Baixa | Alto | .gitignore + .env.example |
| OpenAI fora do ar | Baixa | Alto | Retry 3x + mensagem amigavel |
| Custo inesperado de API | Media | Medio | Log de tokens + alerta se > 3000 tokens |
| Roteiro fora do tom | Media | Alto | System prompt robusto (Story 7.2) |
| Node.js nao instalado | Baixa | Medio | Verificar no setup, instrucoes claras |

## Regras de Comunicacao (Sadhana)

### SEMPRE
- Mensagens do CLI em portugues
- Tom amigavel ate nas mensagens de erro
- Feedback visual durante processamento (spinner)
- Codigo limpo e comentado em portugues

### NUNCA
- Mensagens de erro cruas/tecnicas para o usuario
- Console.log de debug em producao
- API key hardcoded
- Dependencias desnecessarias

## Referencias

- Story 7.1 (Arquitetura) -- estrutura e modulos
- Story 7.2 (Prompts) -- system prompt e templates
- Node.js CLI best practices
- OpenAI Node SDK documentation
- Inquirer.js documentation

## Change Log

| Data | Mudanca | Autor |
|---|---|---|
| 2026-02-14 | Story criada | Morgan (PM) |


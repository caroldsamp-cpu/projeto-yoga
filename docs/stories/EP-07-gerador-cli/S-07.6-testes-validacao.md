# Story 7.6: Testes e Validacao do Gerador CLI

**Epic:** EP-07 - Gerador de Roteiros CLI
**Story ID:** 7.6
**Prioridade:** :dart: Alta
**Pontos:** 8
**Esforco:** 6-8 horas
**Status:** :white_circle: Draft
**Tipo:** :white_check_mark: QA & Validacao

---

## User Story

Como **PM do projeto NamaSer**, quero **testar o gerador CLI gerando 20 roteiros, validando com a Gaby e medindo a taxa de aprovacao**, para que **tenhamos confianca de que a ferramenta produz conteudo autenticamente Sadhana e iteremos os prompts ate atingir qualidade aceitavel**.

## Objetivo

Executar um ciclo completo de testes do CLI: gerar 20 roteiros variados (diferentes temas, avatares e formatos), submeter para validacao da Gaby, medir % de aprovacao e iterar os prompts baseado no feedback. O objetivo e atingir > 80% de aprovacao antes de considerar o CLI pronto para uso em producao.

## Contexto & Fundamentacao

- CLI completo com tema + avatar + formato (Stories 7.3, 7.4, 7.5)
- Prompts de IA ja implementados (Story 7.2)
- Validacao humana e essencial -- IA nao tem como julgar autenticidade de tom
- A Gaby e a validadora final: "eu diria isso?"
- Meta: > 80% de aprovacao para considerar MVP pronto
- Iteracao de prompts e o mecanismo de melhoria (nao mudanca de modelo)
- Documentar padroes de erro para melhorar prompts sistematicamente

## Scope

### Incluido
- Geracao de 20 roteiros com combinacoes variadas
- Matriz de teste: temas x avatares x formatos
- Rubrica de avaliacao para a Gaby (criterios claros)
- Sessao de validacao com feedback documentado
- Analise de padroes de erro (o que a IA erra consistentemente?)
- Iteracao de prompts baseada no feedback
- Re-teste apos iteracao (ciclo 2)
- Testes unitarios basicos para codigo

### Excluido
- Testes de carga ou performance
- Testes automatizados de qualidade de conteudo (NLP)
- Validacao com audiencia final (alunas)
- Testes de usabilidade do CLI (UX)

### Dependencias
- Story 7.3 (CLI Basico) -- CLI funcional
- Story 7.4 (Avatar) -- selecao de avatar
- Story 7.5 (Formato) -- selecao de formato
- Story 7.2 (Prompts) -- prompts a iterar
- Disponibilidade da Gaby para validacao (~1h)

### Entregaveis para downstream
- Prompts iterados (melhor versao)
- Relatorio de qualidade para decisao de go/no-go
- Banco de 20 roteiros validados para uso

## Tasks Breakdown

### Fase 1: Planejamento dos Testes (~1h)
- [ ] Criar matriz de teste (20 combinacoes)
  ```
  | # | Tema              | Avatar  | Formato     |
  |---|-------------------|---------|-------------|
  | 1 | ansiedade         | Marina  | reel-30     |
  | 2 | ansiedade         | Julia   | reel-60     |
  | 3 | ansiedade         | Camila  | carrossel   |
  | 4 | rotina matinal     | Marina  | post-feed   |
  | 5 | rotina matinal     | Julia   | story       |
  | 6 | rotina matinal     | Camila  | reel-30     |
  | 7 | culpa              | Marina  | reel-60     |
  | 8 | culpa              | Julia   | carrossel   |
  | 9 | culpa              | Camila  | post-feed   |
  | 10| autocompaixao     | Marina  | story       |
  | 11| autocompaixao     | Julia   | reel-30     |
  | 12| autocompaixao     | Camila  | reel-60     |
  | 13| presenca          | Geral   | carrossel   |
  | 14| presenca          | Geral   | post-feed   |
  | 15| respiracao         | Marina  | story       |
  | 16| recomecar          | Camila  | reel-30     |
  | 17| primeira pratica   | Julia   | reel-60     |
  | 18| vida real          | Geral   | carrossel   |
  | 19| tempo pra mim      | Marina  | post-feed   |
  | 20| consistencia       | Camila  | story       |
  ```
- [ ] Distribuir equilibradamente: todos os avatares, todos os formatos
- [ ] Garantir variedade de temas (emocional, pratico, filosofico)

### Fase 2: Geracao dos 20 Roteiros (~1.5h)
- [ ] Executar CLI 20 vezes com as combinacoes da matriz
- [ ] Salvar cada roteiro em arquivo .md com metadata
- [ ] Registrar tempo de geracao e tokens usados por roteiro
- [ ] Calcular custo total das 20 geracoes
- [ ] Organizar roteiros em pasta `tests/roteiros-gerados/`
  ```
  tests/roteiros-gerados/
  â”œâ”€â”€ 01-ansiedade-marina-reel30.md
  â”œâ”€â”€ 02-ansiedade-julia-reel60.md
  â”œâ”€â”€ ...
  â””â”€â”€ 20-consistencia-camila-story.md
  ```

### Fase 3: Criar Rubrica de Avaliacao (~0.5h)
- [ ] Definir criterios de avaliacao para a Gaby
  ```markdown
  ## Rubrica de Avaliacao -- Roteiro Sadhana

  Para cada roteiro, avalie de 1 a 5:

  1. TOM (Gaby diria isso?)
     1 = Nao parece comigo / 5 = Parece exatamente comigo

  2. DOR DO AVATAR (Toca na dor certa?)
     1 = Nao reconheco a pessoa / 5 = E exatamente assim que ela sente

  3. LIGHT COPY PATTERN (Segue a estrutura?)
     1 = Perdido, sem estrutura / 5 = Flui naturalmente nos 6 passos

  4. REGRAS SADHANA (Sem marketese, sem imposicao?)
     1 = Parece propaganda / 5 = Zero marketese

  5. USABILIDADE (Usaria esse roteiro como base?)
     1 = Reescreveria tudo / 5 = Publicaria como esta

  RESULTADO:
  - 20-25 pontos: APROVADO (pronto para uso)
  - 15-19 pontos: APROVADO COM AJUSTES (base boa, precisa refinar)
  - 10-14 pontos: REPROVADO (precisa retrabalho no prompt)
  - < 10 pontos: REPROVADO TOTAL (revisar system prompt)

  FEEDBACK ABERTO:
  - O que mudaria neste roteiro?
  - Tem alguma frase que "nao sou eu"?
  - Tem algo que faltou?
  ```
- [ ] Imprimir/formatar para facilitar avaliacao da Gaby

### Fase 4: Sessao de Validacao com a Gaby (~1.5h)
- [ ] Agendar 1h com a Gaby para validacao
- [ ] Apresentar os 20 roteiros (pode ser em batches de 5)
- [ ] Gaby avalia cada roteiro com a rubrica
- [ ] Documentar feedback aberto (citacoes diretas)
- [ ] Identificar padroes de problema:
  - [ ] "Essa frase nao sou eu" -> quais palavras/frases?
  - [ ] "Faltou acolhimento" -> em qual passo do LC Pattern?
  - [ ] "Parece generico" -> personalizacao de avatar fraca?
  - [ ] "Ta muito longo/curto" -> restricoes de formato?
- [ ] Calcular % de aprovacao (pontuacao >= 20)

### Fase 5: Analise de Resultados (~1h)
- [ ] Compilar resultados em tabela
  ```
  | # | Tema | Avatar | Formato | Tom | Dor | LC | Regras | Uso | Total | Status |
  |---|------|--------|---------|-----|-----|-----|--------|-----|-------|--------|
  | 1 | ...  | ...    | ...     | 4   | 3   | 5   | 5      | 4   | 21    | OK     |
  ```
- [ ] Calcular metricas agregadas
  - [ ] % aprovacao total (>= 20 pontos)
  - [ ] Media por criterio (qual criterio e o mais fraco?)
  - [ ] Aprovacao por avatar (qual avatar gera melhor conteudo?)
  - [ ] Aprovacao por formato (qual formato e mais dificil?)
  - [ ] Aprovacao por tema (algum tema e problematico?)
- [ ] Identificar top 3 padroes de erro
- [ ] Priorizar ajustes nos prompts

### Fase 6: Iteracao de Prompts (~1.5h)
- [ ] Baseado no feedback, ajustar prompts:
  - [ ] Se tom e o mais fraco: reforcar vocabulario e exemplos no system prompt
  - [ ] Se dor do avatar e fraca: expandir contextos de avatar
  - [ ] Se LC Pattern e inconsistente: tornar estrutura mais explicita
  - [ ] Se regras Sadhana sao violadas: adicionar mais regras negativas
  - [ ] Se formato e ignorado: reforcar restricoes com CAPS e exemplos
- [ ] Versionar prompts (v1.0 -> v1.1)
- [ ] Documentar cada mudanca e justificativa

### Fase 7: Re-teste (Ciclo 2) (~1h)
- [ ] Selecionar os 5 piores roteiros do ciclo 1
- [ ] Re-gerar com os mesmos parametros (prompts v1.1)
- [ ] Comparar pontuacao ciclo 1 vs ciclo 2
- [ ] Se melhoria > 15%: aprovar prompts v1.1
- [ ] Se melhoria < 15%: iterar mais (ciclo 3 se necessario)

### Fase 8: Testes Unitarios de Codigo (~1h)
- [ ] Escrever testes para `validator.js`
  - [ ] Tema vazio retorna erro
  - [ ] Avatar invalido retorna erro
  - [ ] Formato invalido retorna erro
  - [ ] Inputs validos passam
- [ ] Escrever testes para `prompt-builder.js`
  - [ ] Prompt montado contem system prompt
  - [ ] Prompt com avatar contem contexto do avatar
  - [ ] Prompt com formato contem estrutura do formato
  - [ ] Arquivo inexistente gera erro tratado
- [ ] Escrever testes para `formatter.js`
  - [ ] Output contem metadata
  - [ ] Arquivo salvo tem formato correto
- [ ] Executar testes: `npm test`
- [ ] Garantir 100% de testes passando

## Acceptance Criteria

### Must Have
- [ ] 20 roteiros gerados com combinacoes variadas
- [ ] Rubrica de avaliacao definida (5 criterios, escala 1-5)
- [ ] Sessao de validacao com a Gaby realizada
- [ ] % de aprovacao calculada
- [ ] Se aprovacao < 80%: pelo menos 1 ciclo de iteracao nos prompts
- [ ] Resultados documentados em tabela
- [ ] Testes unitarios basicos passando (validator, prompt-builder, formatter)

### Should Have
- [ ] Re-teste (ciclo 2) com prompts iterados
- [ ] Melhoria mensuravel entre ciclo 1 e ciclo 2
- [ ] Top 3 padroes de erro documentados
- [ ] Prompts versionados (v1.0, v1.1)
- [ ] Custo total das geracoes documentado

### Nice to Have
- [ ] Benchmark: roteiro gerado vs roteiro escrito pela Gaby (teste cego)
- [ ] Automacao da rubrica (checklist no terminal apos geracao)
- [ ] Banco dos 20 roteiros como "biblioteca" de conteudo
- [ ] Coverage de testes > 80%

## Entregaveis

| Entregavel | Localizacao | Conteudo | Usado Por |
|---|---|---|---|
| 20 Roteiros Gerados | `tests/roteiros-gerados/` | Roteiros com metadata | Gaby, equipe |
| Rubrica de Avaliacao | `docs/cli/rubrica-avaliacao.md` | Criterios e escala | Gaby |
| Relatorio de Resultados | `docs/cli/relatorio-testes-v1.md` | Tabela, metricas, padroes | PM, Dev |
| Prompts Iterados | `prompts/` (versionados) | System prompt v1.1+ | CLI |
| Testes Unitarios | `tests/*.test.js` | Testes de codigo | Dev |

## Metricas de Sucesso

| Metrica | Meta | Como Medir |
|---|---|---|
| % aprovacao (ciclo 1) | > 60% | Rubrica (>= 20 pontos) |
| % aprovacao (ciclo 2) | > 80% | Rubrica (>= 20 pontos) |
| Melhoria ciclo 1 -> ciclo 2 | > 15% | Comparacao de medias |
| Media criterio TOM | > 4.0 | Media das avaliacoes |
| Media criterio REGRAS | > 4.5 | Media das avaliacoes |
| Custo total das 20 geracoes | < R$4,00 | Log de tokens |
| Testes unitarios passando | 100% | npm test |
| Cobertura de testes | > 70% | vitest coverage |

## Riscos & Mitigacao

| Risco | Probabilidade | Impacto | Mitigacao |
|---|---|---|---|
| Gaby nao tem tempo para validar 20 roteiros | Media | Alto | Preparar batches de 5, marcar com antecedencia |
| Taxa de aprovacao muito baixa (< 40%) | Media | Alto | Iterar prompts com foco nos padroes de erro |
| Gaby e rigorosa demais (nada passa) | Baixa | Medio | Calibrar rubrica: "usaria como base" vs "publicaria" |
| Iteracao nao melhora significativamente | Media | Alto | Mudar abordagem: mais few-shot examples |
| Custo de API alto nas iteracoes | Baixa | Medio | Usar modelo mais barato para testes (gpt-3.5) |

## Regras de Comunicacao (Sadhana)

### SEMPRE
- Feedback da Gaby documentado com citacoes exatas
- Respeitar a intuicao da Gaby ("se nao sou eu, nao e")
- Iterar com cuidado (mudancas pequenas, testar)
- Comemorar melhorias (mesmo pequenas)
- Tratar reprovacao como aprendizado (nao como falha)

### NUNCA
- Pressionar a Gaby a aprovar roteiro que "quase" funciona
- Ignorar feedback qualitativo ("a frase ta estranha")
- Mudar tudo de uma vez (iterar incrementalmente)
- Publicar roteiro sem aprovacao explicita
- Descartar roteiros reprovados (sao dados de melhoria)

## Referencias

- Story 7.2 (Prompts) -- prompts a serem validados e iterados
- Story 7.3 (CLI Basico) -- CLI para executar testes
- Story 7.4 (Avatar) -- personalizacao a ser validada
- Story 7.5 (Formato) -- formatos a serem validados
- Story 1.1 (Manifesto Sadhana) -- referencia de tom
- Vitest documentation -- framework de testes

## Change Log

| Data | Mudanca | Autor |
|---|---|---|
| 2026-02-14 | Story criada | Morgan (PM) |

